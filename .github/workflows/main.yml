name: ğŸ–¥ï¸ RDP 24/7

on:
  workflow_dispatch:
  schedule:
    # Se ejecuta automÃ¡ticamente cada 5 dÃ­as para mantener 24/7
    - cron: '0 */120 * * *'

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 35000  # ~24 dÃ­as (cerca del mÃ¡ximo de GitHub)

    steps:
      - name: ğŸ¯ Inicializando Entorno RDP
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘     ğŸ–¥ï¸  INICIANDO SERVIDOR RDP 24/7   â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "â° Inicio: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Green
          Write-Host "ğŸ”§ Run ID: $env:GITHUB_RUN_ID" -ForegroundColor Yellow
          Write-Host ""

      - name: âš™ï¸ Configurar RDP
        run: |
          Write-Host "ğŸ”§ Configurando Remote Desktop Protocol..." -ForegroundColor Cyan
          
          try {
            # Habilitar RDP
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                               -Name "fDenyTSConnections" -Value 0 -Force
            Write-Host "  âœ… RDP habilitado" -ForegroundColor Green
            
            # Configurar autenticaciÃ³n
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                               -Name "UserAuthentication" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                               -Name "SecurityLayer" -Value 0 -Force
            Write-Host "  âœ… ConfiguraciÃ³n de seguridad aplicada" -ForegroundColor Green
            
            # Configurar firewall
            netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
            netsh advfirewall firewall add rule name="RDP-Tailscale" `
              dir=in action=allow protocol=TCP localport=3389 | Out-Null
            Write-Host "  âœ… Regla de firewall creada" -ForegroundColor Green
            
            # Reiniciar servicio
            Restart-Service -Name TermService -Force
            Write-Host "  âœ… Servicio RDP reiniciado" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host "  âŒ Error en configuraciÃ³n: $_" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ‘¤ Crear Usuario RDP
        run: |
          Write-Host "ğŸ‘¤ Generando credenciales seguras..." -ForegroundColor Cyan
          
          try {
            # Generar contraseÃ±a compleja
            Add-Type -AssemblyName System.Security
            $charSet = @{
                Upper   = [char[]](65..90)
                Lower   = [char[]](97..122)
                Number  = [char[]](48..57)
                Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
            }
            $rawPassword = @()
            $rawPassword += $charSet.Upper | Get-Random -Count 4
            $rawPassword += $charSet.Lower | Get-Random -Count 4
            $rawPassword += $charSet.Number | Get-Random -Count 4
            $rawPassword += $charSet.Special | Get-Random -Count 4
            $password = -join ($rawPassword | Sort-Object { Get-Random })
            
            # Crear usuario
            $securePass = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction Stop | Out-Null
            Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction Stop
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction Stop
            
            Write-Host "  âœ… Usuario creado exitosamente" -ForegroundColor Green
            
            # Guardar credenciales
            echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
            
            # Verificar creaciÃ³n
            if (-not (Get-LocalUser -Name "RDP")) {
                throw "Fallo en verificaciÃ³n de usuario"
            }
            Write-Host "  âœ… Usuario verificado" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host "  âŒ Error creando usuario: $_" -ForegroundColor Red
            exit 1
          }

      - name: ğŸŒ Instalar Tailscale
        run: |
          Write-Host "ğŸŒ Instalando Tailscale VPN..." -ForegroundColor Cyan
          
          try {
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            Write-Host "  ğŸ“¥ Descargando instalador..." -ForegroundColor Yellow
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
            
            Write-Host "  ğŸ“¦ Instalando..." -ForegroundColor Yellow
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            
            Write-Host "  âœ… Tailscale instalado" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host "  âŒ Error instalando Tailscale: $_" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ”— Conectar a Tailscale
        run: |
          Write-Host "ğŸ”— Estableciendo conexiÃ³n Tailscale..." -ForegroundColor Cyan
          
          try {
            # Conectar Tailscale
            $hostname = "gh-rdp-$env:GITHUB_RUN_ID"
            Write-Host "  ğŸ·ï¸  Hostname: $hostname" -ForegroundColor Yellow
            
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hostname
            
            # Esperar por IP
            Write-Host "  â³ Esperando asignaciÃ³n de IP..." -ForegroundColor Yellow
            $tsIP = $null
            $retries = 0
            while (-not $tsIP -and $retries -lt 12) {
                Start-Sleep -Seconds 3
                $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                if ($tsIP) { break }
                $retries++
                Write-Host "    â€¢ Intento $($retries)/12..." -ForegroundColor Gray
            }
            
            if (-not $tsIP) {
                throw "No se pudo obtener IP de Tailscale"
            }
            
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "  âœ… IP asignada: $tsIP" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host "  âŒ Error conectando Tailscale: $_" -ForegroundColor Red
            exit 1
          }

      - name: âœ… Verificar Conectividad RDP
        run: |
          Write-Host "âœ… Verificando acceso RDP..." -ForegroundColor Cyan
          
          try {
            $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
            
            if (-not $testResult.TcpTestSucceeded) {
                throw "ConexiÃ³n TCP fallida en puerto 3389"
            }
            
            Write-Host "  âœ… Puerto 3389 accesible" -ForegroundColor Green
            Write-Host "  âœ… Servidor RDP listo" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host "  âŒ Error verificando conectividad: $_" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ“‹ Generar Resumen de Acceso
        run: |
          $summary = @"
          ## ğŸ‰ Servidor RDP Activo
          
          ### ğŸ“¡ InformaciÃ³n de ConexiÃ³n
          
          | Campo | Valor |
          |-------|-------|
          | ğŸŒ **DirecciÃ³n IP** | ``$env:TAILSCALE_IP`` |
          | ğŸ‘¤ **Usuario** | ``RDP`` |
          | ğŸ”‘ **ContraseÃ±a** | ``$env:RDP_PASSWORD`` |
          | ğŸ·ï¸ **Hostname** | ``gh-rdp-$env:GITHUB_RUN_ID`` |
          | â° **Iniciado** | $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC') |
          | â±ï¸ **DuraciÃ³n MÃ¡x** | ~24 dÃ­as |
          
          ### ğŸ”§ Instrucciones de ConexiÃ³n
          
          **Windows:**
          1. Presiona ``Win + R``
          2. Escribe: ``mstsc``
          3. Ingresa la IP: ``$env:TAILSCALE_IP``
          4. Usa las credenciales de arriba
          
          **Linux/Mac:**
          \`\`\`bash
          rdesktop $env:TAILSCALE_IP -u RDP -p '$env:RDP_PASSWORD'
          # O con Remmina/Microsoft Remote Desktop
          \`\`\`
          
          ### âš ï¸ Importante
          - âœ… AsegÃºrate de estar conectado a Tailscale
          - âœ… El servidor se mantendrÃ¡ activo ~24 dÃ­as
          - âœ… Se reiniciarÃ¡ automÃ¡ticamente cada 5 dÃ­as
          - âŒ Cancela el workflow manualmente si ya no lo necesitas
          
          ### ğŸ›‘ Para Detener
          Cancela este workflow desde Actions â†’ RDP 24/7 â†’ Cancel workflow
          
          ---
          *âš¡ Powered by GitHub Actions + Tailscale*
          "@
          
          echo $summary >> $env:GITHUB_STEP_SUMMARY

      - name: ğŸ“¢ Mostrar Credenciales
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘                                                        â•‘" -ForegroundColor Green
          Write-Host "â•‘              ğŸ‰ SERVIDOR RDP ACTIVO ğŸ‰                 â•‘" -ForegroundColor Green
          Write-Host "â•‘                                                        â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘                                                        â•‘" -ForegroundColor Green
          Write-Host "â•‘  ğŸŒ IP:        $($env:TAILSCALE_IP.PadRight(35)) â•‘" -ForegroundColor White
          Write-Host "â•‘  ğŸ‘¤ Usuario:   RDP                                     â•‘" -ForegroundColor White
          Write-Host "â•‘  ğŸ”‘ Password:  $($env:RDP_PASSWORD.PadRight(35)) â•‘" -ForegroundColor White
          Write-Host "â•‘                                                        â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  â° Tiempo activo: ~24 dÃ­as mÃ¡ximo                     â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  ğŸ”„ Auto-reinicio: Cada 5 dÃ­as                         â•‘" -ForegroundColor Yellow
          Write-Host "â•‘                                                        â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""

      - name: â™¾ï¸ Mantener ConexiÃ³n Activa 24/7
        run: |
          Write-Host "â™¾ï¸  Modo 24/7 Activado - Servidor corriendo indefinidamente..." -ForegroundColor Magenta
          Write-Host ""
          Write-Host "ğŸ’¡ Consejos:" -ForegroundColor Cyan
          Write-Host "   â€¢ Revisa el 'Summary' de este workflow para ver las credenciales" -ForegroundColor Gray
          Write-Host "   â€¢ Este workflow se reiniciarÃ¡ automÃ¡ticamente cada 5 dÃ­as" -ForegroundColor Gray
          Write-Host "   â€¢ Para detener: Cancela manualmente desde GitHub Actions" -ForegroundColor Gray
          Write-Host ""
          
          $startTime = Get-Date
          $iteration = 0
          
          while ($true) {
              $iteration++
              $elapsed = (Get-Date) - $startTime
              $uptime = "{0:dd}d {0:hh}h {0:mm}m" -f $elapsed
              
              # Verificar salud del servicio cada iteraciÃ³n
              $rdpStatus = (Get-Service -Name TermService).Status
              $tsStatus = if (Get-Process -Name tailscaled -ErrorAction SilentlyContinue) { "âœ…" } else { "âŒ" }
              
              # Log rotativo cada 5 minutos
              Write-Host "[$((Get-Date).ToString('HH:mm:ss'))] ğŸŸ¢ Activo | â±ï¸  $uptime | RDP: $rdpStatus | Tailscale: $tsStatus | Iter: $iteration" -ForegroundColor Green
              
              # Heartbeat cada 5 minutos
              Start-Sleep -Seconds 300
              
              # Cada hora mostrar recordatorio
              if ($iteration % 12 -eq 0) {
                  Write-Host ""
                  Write-Host "  ğŸ“Š Estado del Sistema:" -ForegroundColor Cyan
                  Write-Host "     ğŸ–¥ï¸  IP: $env:TAILSCALE_IP" -ForegroundColor White
                  Write-Host "     â° Uptime: $uptime" -ForegroundColor White
                  Write-Host "     ğŸ‘¤ Usuario: RDP" -ForegroundColor White
                  Write-Host ""
              }
          }
